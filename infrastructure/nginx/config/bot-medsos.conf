# Rate Limiting Configuration
# Official Ref: https://core.telegram.org/bots/webhooks
# limit_req_zone $binary_remote_addr zone=bot_limit:10m rate=10r/s; # Must be in http block

server {
    listen 8080;
    listen [::]:8080; # Fix: Enable IPv6 listener for Cloudflare Tunnel
    server_name bot.opinionry.my.id;

    # SECURITY: Hide Nginx Version
    server_tokens off;

    # SECURITY: Restrict Methods (Official Rec: POST for Webhooks)
    if ($request_method !~ ^(GET|POST|HEAD)$) {
        return 405;
    }

    # SECURITY: Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    # LOGGING
    access_log /var/log/nginx/bot-medsos-access.log combined;
    error_log /var/log/nginx/bot-medsos-error.log warn;

    # PERFORMANCE: Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

    location / {
        # REAL IP: Trust Local Tunnel (cloudflared)
        set_real_ip_from 127.0.0.1;
        set_real_ip_from ::1;
        real_ip_header CF-Connecting-IP;

        # Rate Limiting: "Paranoid Mode"
        # burst=0 ensures NO queue. Hit 2 in 6 seconds = Blocked.
        limit_req zone=bot_limit burst=1 nodelay;

        # Proxy Configuration
        proxy_pass http://localhost:3000;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        
        # REAL IP: Trust Cloudflare IPs
        # (List of CF IPs should be added in real_ip configuration, but generic config here)
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;

        # TIMEOUTS: Tuning for stability
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # BUFFERING
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
    }
    
    # SECURITY: Block hidden files (except .well-known)
    location ~ /\.(?!well-known) {
        deny all;
        access_log off;
        log_not_found off;
    }
}
