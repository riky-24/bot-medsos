version: '3.8'

services:
  # Nginx with ModSecurity WAF (Bunkerized)
  nginx:
    image: bunkerity/bunkerweb:1.5.8
    container_name: bot-medsos-nginx-waf
    environment:
      # General Configuration
      - SERVER_NAME=${SERVER_NAME:-bot.opinionry.my.id}
      - AUTO_LETS_ENCRYPT=no
      - USE_GZIP=yes
      - USE_REALIP=yes
      - REALIP_FROM=172.20.0.0/16

      # Proxy Configuration (Route checks to app)
      - SERVE_PATH_0=/
      - SERVE_PROXY_0=http://app:3000

      # Security Configuration
      - USE_MODSECURITY=yes
      - USE_MODSECURITY_CRS=yes
      - USE_LIMIT_REQ=yes
      - LIMIT_REQ_RATE=10r/s
      - LIMIT_REQ_BURST=20
      - DISABLE_DEFAULT_SERVER=yes
    volumes:
      - ../bunkerweb/config/modsecurity-custom-rules:/modsec-crs-confs:ro
      - ../../logs/nginx:/var/log/bunkerweb
    depends_on:
      app:
        condition: service_healthy
    networks:
      - bot-network
    security_opt:
      - no-new-privileges:true
